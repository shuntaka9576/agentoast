[config]
default_to_workspace = false

# ---------------------------------------------------------------------------
# Setup
# ---------------------------------------------------------------------------
[tasks.setup]
description = "Install frontend dependencies"
command = "bun"
args = ["install"]

# ---------------------------------------------------------------------------
# Build
# ---------------------------------------------------------------------------
[tasks.build-cli]
description = "Build CLI in release mode"
command = "cargo"
args = ["build", "-p", "agentoast-cli", "--release"]

[tasks.build-app]
description = "Build Tauri app in release mode"
command = "bun"
args = ["run", "tauri", "build"]

[tasks.build]
description = "Build CLI + Tauri app"
dependencies = ["build-cli", "build-app"]

# ---------------------------------------------------------------------------
# Install
# ---------------------------------------------------------------------------
[tasks.stop-app]
description = "Stop running Agentoast app"
script = ["pkill -x agentoast-app || true"]

[tasks.install-cli]
description = "Install CLI via cargo install"
command = "cargo"
args = ["install", "--path", "crates/agentoast-cli"]

[tasks.install-app]
description = "Copy built .app to /Applications/"
script = ["cp -r target/release/bundle/macos/Agentoast.app /Applications/"]

[tasks.install]
description = "Build and install CLI + app"
dependencies = ["stop-app", "build"]
run_task = { name = ["install-cli", "install-app"], parallel = false }

# ---------------------------------------------------------------------------
# Uninstall
# ---------------------------------------------------------------------------
[tasks.uninstall]
description = "Stop app, remove .app from /Applications/, and uninstall CLI"
dependencies = ["stop-app"]
script = '''
rm -rf /Applications/Agentoast.app
cargo uninstall agentoast-cli 2>/dev/null || true
echo "Done! Uninstalled agentoast"
'''

# ---------------------------------------------------------------------------
# Dev
# ---------------------------------------------------------------------------
[tasks.dev]
description = "Start Tauri dev mode"
command = "bun"
args = ["run", "tauri", "dev"]

# ---------------------------------------------------------------------------
# Launch
# ---------------------------------------------------------------------------
[tasks.launch]
description = "Launch installed app"
command = "open"
args = ["/Applications/Agentoast.app"]

# ---------------------------------------------------------------------------
# Publish
# ---------------------------------------------------------------------------
[tasks.publish-app]
description = "Build DMG, upload to GitHub Release, and update Cask"
script = '''
VERSION=$(grep -m1 'version' Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
TAG="v${VERSION}"
DMG_NAME="Agentoast_${VERSION}_aarch64.dmg"

echo "Publishing Agentoast app ${TAG}..."

# 1. Build Tauri app
cargo make build-app

# 2. Upload DMG to GitHub Release
gh release upload "${TAG}" "target/release/bundle/dmg/${DMG_NAME}" --clobber

# 3. Update Cask via GitHub Contents API
SHA256=$(shasum -a 256 "target/release/bundle/dmg/${DMG_NAME}" | awk '{print $1}')
DMG_URL="https://github.com/shuntaka9576/agent-notify/releases/download/${TAG}/${DMG_NAME}"

CASK_CONTENT=$(cat <<CASK_EOF
cask "agentoast" do
  version "${VERSION}"
  sha256 "${SHA256}"

  url "${DMG_URL}"
  name "Agentoast"
  desc "macOS menu bar notification app for AI coding agents"
  homepage "https://github.com/shuntaka9576/agent-notify"

  app "Agentoast.app"

  zap trash: [
    "~/.local/share/agentoast",
    "~/.config/agentoast",
  ]
end
CASK_EOF
)

ENCODED=$(echo "${CASK_CONTENT}" | base64)
EXISTING_SHA=$(gh api repos/shuntaka9576/homebrew-tap/contents/Casks/agentoast.rb --jq '.sha' 2>/dev/null || echo "")

if [ -n "${EXISTING_SHA}" ]; then
  gh api repos/shuntaka9576/homebrew-tap/contents/Casks/agentoast.rb \
    --method PUT \
    -f message="Update agentoast cask to ${TAG}" \
    -f content="${ENCODED}" \
    -f sha="${EXISTING_SHA}"
else
  gh api repos/shuntaka9576/homebrew-tap/contents/Casks/agentoast.rb \
    --method PUT \
    -f message="Add agentoast cask ${TAG}" \
    -f content="${ENCODED}"
fi

echo "Done! Published ${TAG}"
'''

# ---------------------------------------------------------------------------
# Lint
# ---------------------------------------------------------------------------
[tasks.fmt-check]
description = "Check Rust formatting"
command = "cargo"
args = ["fmt", "--all", "--", "--check"]

[tasks.clippy]
description = "Run clippy on workspace"
command = "cargo"
args = ["clippy", "--workspace", "--", "-D", "warnings"]

[tasks.lint-oxlint]
description = "Run oxlint"
command = "bun"
args = ["x", "oxlint", ".", "--type-aware", "--type-check", "--deny-warnings"]

[tasks.spell-check]
description = "Run cspell"
command = "bun"
args = ["x", "cspell", "lint", ".", "--cache", "--gitignore"]

[tasks.lint]
description = "Run all linters (Rust + frontend)"
dependencies = ["fmt-check", "clippy", "lint-oxlint", "spell-check"]

# ---------------------------------------------------------------------------
# Clean
# ---------------------------------------------------------------------------
[tasks.clean]
description = "Remove build artifacts"
script = [
    "cargo clean",
    "rm -rf dist",
]
